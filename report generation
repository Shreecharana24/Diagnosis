#include <hpdf.h>
#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <string.h>

void error_handler(HPDF_STATUS error_no, HPDF_STATUS detail_no, void *user_data) {
    printf("ERROR: error_no=%04X, detail_no=%d\n", (HPDF_UINT)error_no, (HPDF_INT)detail_no);
    exit(1);
}

void get_current_date(char *buffer, size_t size) {
    time_t t = time(NULL);
    struct tm tm = *localtime(&t);
    snprintf(buffer, size, "%02d-%02d-%d", tm.tm_mday, tm.tm_mon + 1, tm.tm_year + 1900);
}

int generate_report(const char *patient_name, const char *symptoms, const char *diagnosis_result) {
    HPDF_Doc pdf;
    HPDF_Page page;
    HPDF_Font font;
    char date[20];

    pdf = HPDF_New(error_handler, NULL);
    if (!pdf) {
        printf("Failed to create PDF object.\n");
        return 1;
    }

    get_current_date(date, sizeof(date));
    page = HPDF_AddPage(pdf);
    HPDF_Page_SetSize(page, HPDF_PAGE_SIZE_A4, HPDF_PAGE_PORTRAIT);

    font = HPDF_GetFont(pdf, "Helvetica", NULL);
    HPDF_Page_SetFontAndSize(page, font, 16);

    // Title
    HPDF_Page_BeginText(page);
    HPDF_Page_TextOut(page, 50, 800, "Medical Diagnosis Report");
    HPDF_Page_SetFontAndSize(page, font, 12);
    HPDF_Page_TextOut(page, 50, 780, "Generated by Diagnosis System");
    HPDF_Page_EndText(page);

    // Date and Patient Info
    HPDF_Page_BeginText(page);
    char buffer[256];
    snprintf(buffer, sizeof(buffer), "Date: %s", date);
    HPDF_Page_TextOut(page, 50, 750, buffer);

    snprintf(buffer, sizeof(buffer), "Patient Name: %s", patient_name);
    HPDF_Page_TextOut(page, 50, 730, buffer);

    HPDF_Page_TextOut(page, 50, 710, "Symptoms:");
    HPDF_Page_TextRect(page, 50, 690, 550, 650, symptoms, HPDF_TALIGN_LEFT, NULL);

    HPDF_Page_TextOut(page, 50, 620, "Diagnosis Result:");
    HPDF_Page_TextRect(page, 50, 600, 550, 560, diagnosis_result, HPDF_TALIGN_LEFT, NULL);
    HPDF_Page_EndText(page);

    // Save
    HPDF_SaveToFile(pdf, "diagnosis_report.pdf");
    HPDF_Free(pdf);

    printf("Diagnosis report generated: diagnosis_report.pdf\n");
    return 0;
}

int main() {
    // Example data (replace with actual user input from your system)
    const char *patient_name = "John Doe";
    const char *symptoms = "Fever, Cough, Headache, Fatigue";
    const char *diagnosis_result = "Likely a viral infection. Recommend rest, hydration, and further lab tests if symptoms persist.";

    generate_report(patient_name, symptoms, diagnosis_result);
    return 0;
}
